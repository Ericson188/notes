<!DOCTYPE html>
<html>
<head>
    <title>Harmony Music Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #8e44ad;
            --primary-light: #9b59b6;
            --secondary: #3498db;
            --dark: #1a1a2e;
            --darker: #16213e;
            --light: #e2e8f0;
            --text: #f1f1f1;
            --text-secondary: #b8c2cc;
            --bg: linear-gradient(to right, var(--darker), var(--dark));
            --card-bg: rgba(26, 26, 46, 0.8);
            --player-bg: rgba(30, 30, 60, 0.95);
        }

        /* Light mode variables */
        .light-mode {
            --primary: #9b59b6;
            --primary-light: #8e44ad;
            --secondary: #2980b9;
            --dark: #f8f9fa;
            --darker: #e9ecef;
            --light: #343a40;
            --text: #212529;
            --text-secondary: #495057;
            --bg: linear-gradient(to right, #e9ecef, #f8f9fa);
            --card-bg: rgba(255, 255, 255, 0.9);
            --player-bg: rgba(255, 255, 255, 0.95);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.1s;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            padding: 0;
            line-height: 1.6;
            padding-bottom: 80px; /* Space for player */
        }
        
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            min-height: 100vh;
        }
        
        header {
            padding: 30px 25px 25px;
            text-align: center;
            position: relative;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-weight: 300;
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
        }
        
        .search-container {
            padding: 20px;
            position: relative;
        }
        
        .search-box {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .search-box:focus-within {
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.3);
            border-color: var(--primary);
        }
        
        input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            font-size: 16px;
            outline: none;
            background: transparent;
            color: var(--text);
        }
        
        input::placeholder {
            color: var(--text-secondary);
        }
        
        .search-btn {
            padding: 0 25px;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .search-btn:hover {
            background: var(--primary-light);
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 20px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        #results {
            padding: 0 20px 100px;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin: 25px 0 15px;
            color: var(--text);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .section-actions {
            display: flex;
            gap: 10px;
        }
        
        .section-action {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .section-action:hover {
            background: var(--primary);
            color: white;
        }
        
        .track {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
            position: relative;
        }
        
        .track:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .track-cover {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .track-info {
            flex: 1;
            min-width: 0;
        }
        
        .track-title {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
        }
        
        .track-artist {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-album {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-release {
            font-size: 0.7rem;
            color: var(--secondary);
            margin-top: 3px;
        }
        
        .audio-container {
            margin-top: 12px;
            width: 100%;
        }
        
        audio {
            width: 100%;
            border-radius: 10px;
        }
        
        audio::-webkit-media-controls-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .track-actions {
            position: absolute;
            right: 15px;
            top: 15px;
            display: flex;
            gap: 8px;
        }
        
        .track-action {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .track-action:hover {
            background: var(--primary);
            color: white;
        }
        
        .track-action.favorite {
            color: #ff6b6b;
        }
        
        .track-action.favorite:hover {
            background: rgba(255, 107, 107, 0.2);
        }
        
        .loading {
            text-align: center;
            padding: 50px 20px;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            color: #ff6b6b;
            border-radius: 8px;
            text-align: center;
            margin: 20px;
            border-left: 4px solid #ff6b6b;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            color: var(--primary);
            opacity: 0.7;
        }
        
        .empty-state h3 {
            color: var(--text);
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        /* Player Controls */
        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--player-bg);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .player-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .player-info {
            flex: 1;
            min-width: 0;
        }
        
        .player-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
            font-size: 0.95rem;
        }
        
        .player-artist {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .player-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .player-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
        }
        
        .player-btn.main {
            font-size: 1.5rem;
            background: var(--primary);
            color: white;
        }
        
        .player-btn.main:hover {
            background: var(--primary-light);
        }
        
        .player-progress {
            flex: 1;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.1s;
        }
        
        .time-display {
            font-size: 0.7rem;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }
        
        /* Playlist modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .playlist-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .playlist-item.active {
            color: var(--primary);
        }
        
        .playlist-actions {
            display: flex;
            gap: 10px;
        }
        
        .playlist-action {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .playlist-action:hover {
            color: var(--primary);
        }
        
        .new-playlist {
            display: flex;
            margin-top: 15px;
        }
        
        .new-playlist input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px 0 0 8px;
            color: var(--text);
        }
        
        .new-playlist button {
            padding: 0 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
        }
        
        /* Mobile specific styles */
        @media (max-width: 600px) {
            .app-container {
                border-radius: 0;
                min-height: 100vh;
            }
            
            header {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            .track {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            
            .track-cover {
                width: 100%;
                height: auto;
                aspect-ratio: 1;
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .search-box {
                flex-direction: column;
                border-radius: 12px;
            }
            
            input {
                padding: 15px;
                border-radius: 12px 12px 0 0 !important;
            }
            
            .search-btn {
                padding: 15px;
                border-radius: 0 0 12px 12px !important;
            }
            
            .player-container {
                padding: 10px 15px;
            }
            
            .player-info {
                display: none;
            }
            
            .player-progress {
                display: none;
            }
            
            .player-controls {
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-content">
            <h1><i class="fas fa-music" style="margin-right: 10px;"></i>Harmony</h1>
            <p class="subtitle">Discover and play music previews</p>
        </div>
        <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </header>
    
    <div class="search-container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Artist, song, or album..." autocomplete="off">
            <button class="search-btn" onclick="searchMusic()">
                <i class="fas fa-search" style="margin-right: 8px;"></i> Search
            </button>
        </div>
        <div class="filter-options">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="artist">Artists</button>
            <button class="filter-btn" data-filter="track">Tracks</button>
            <button class="filter-btn" data-filter="album">Albums</button>
        </div>
    </div>
    
    <div id="results">
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-headphones"></i>
            </div>
            <h3>Start Exploring Music</h3>
            <p>Search for your favorite artists or songs to play previews</p>
        </div>
    </div>
</div>

<!-- Player Controls -->
<div class="player-container" id="playerContainer" style="display: none;">
    <img class="player-cover" id="playerCover" src="https://via.placeholder.com/50">
    <div class="player-info">
        <div class="player-title" id="playerTitle">No track selected</div>
        <div class="player-artist" id="playerArtist">Harmony Player</div>
    </div>
    <div class="player-progress">
        <span class="time-display" id="currentTime">0:00</span>
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="time-display" id="duration">0:30</span>
    </div>
    <div class="player-controls">
        <button class="player-btn" id="prevBtn">
            <i class="fas fa-step-backward"></i>
        </button>
        <button class="player-btn main" id="playBtn">
            <i class="fas fa-play"></i>
        </button>
        <button class="player-btn" id="nextBtn">
            <i class="fas fa-step-forward"></i>
        </button>
    </div>
</div>

<!-- Playlist Modal -->
<div class="modal" id="playlistModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Add to Playlist</div>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="playlistModalBody">
            <div class="new-playlist">
                <input type="text" id="newPlaylistName" placeholder="New playlist name">
                <button id="createPlaylistBtn">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentTracks = [];
    let currentTrackIndex = 0;
    let currentAudio = null;
    let isPlaying = false;
    let currentFilter = 'all';
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    let playlists = JSON.parse(localStorage.getItem('playlists')) || {};
    let currentTheme = localStorage.getItem('theme') || 'dark';
    
    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const playerContainer = document.getElementById('playerContainer');
    const playerCover = document.getElementById('playerCover');
    const playerTitle = document.getElementById('playerTitle');
    const playerArtist = document.getElementById('playerArtist');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const themeToggle = document.getElementById('themeToggle');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const playlistModal = document.getElementById('playlistModal');
    const closeModal = document.getElementById('closeModal');
    const playlistModalBody = document.getElementById('playlistModalBody');
    const newPlaylistName = document.getElementById('newPlaylistName');
    const createPlaylistBtn = document.getElementById('createPlaylistBtn');
    
    // Initialize the app
    function init() {
        applyTheme();
        setupEventListeners();
        loadPlaylists();
    }
    
    // Apply saved theme
    function applyTheme() {
        if (currentTheme === 'light') {
            document.body.classList.add('light-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            document.body.classList.remove('light-mode');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
    }
    
    // Set up event listeners
    function setupEventListeners() {
        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);
        
        // Search input
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchMusic();
        });
        
        // Filter buttons
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                filterButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                filterResults();
            });
        });
        
        // Player controls
        playBtn.addEventListener('click', togglePlay);
        prevBtn.addEventListener('click', playPreviousTrack);
        nextBtn.addEventListener('click', playNextTrack);
        
        // Progress bar
        progressBar.addEventListener('click', function(e) {
            if (!currentAudio) return;
            const percent = e.offsetX / this.offsetWidth;
            currentAudio.currentTime = percent * currentAudio.duration;
        });
        
        // Playlist modal
        closeModal.addEventListener('click', closePlaylistModal);
        createPlaylistBtn.addEventListener('click', createNewPlaylist);
    }
    
    // Toggle between dark and light theme
    function toggleTheme() {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', currentTheme);
        applyTheme();
    }
    
    // Search music function
    function searchMusic() {
        const query = searchInput.value.trim();
        
        if (!query) {
            showError('Please enter a search term');
            return;
        }
        
        showLoading(`Searching for "${query}"...`);
        
        // Remove any previous JSONP scripts
        document.querySelectorAll('script[src^="https://api.deezer.com"]').forEach(script => script.remove());
        
        // Search based on current filter
        let searchUrl;
        if (currentFilter === 'artist') {
            searchUrl = `https://api.deezer.com/search/artist?q=${encodeURIComponent(query)}&output=jsonp&callback=handleArtistSearch`;
        } else if (currentFilter === 'album') {
            searchUrl = `https://api.deezer.com/search/album?q=${encodeURIComponent(query)}&output=jsonp&callback=handleAlbumSearch`;
        } else if (currentFilter === 'track') {
            searchUrl = `https://api.deezer.com/search/track?q=${encodeURIComponent(query)}&output=jsonp&callback=handleTrackSearch`;
        } else {
            searchUrl = `https://api.deezer.com/search?q=${encodeURIComponent(query)}&output=jsonp&callback=handleInitialSearch`;
        }
        
        const searchScript = document.createElement('script');
        searchScript.src = searchUrl;
        document.body.appendChild(searchScript);
    }
    
    // Handle initial search (all types)
    function handleInitialSearch(data) {
        if (!data || !data.data || data.data.length === 0) {
            showError('No results found. Try a different search.');
            return;
        }
        
        // Group results by type
        const tracks = data.data.filter(item => item.type === 'track');
        const artists = data.data.filter(item => item.type === 'artist');
        const albums = data.data.filter(item => item.type === 'album');
        
        resultsDiv.innerHTML = '';
        currentTracks = [];
        
        if (tracks.length > 0) {
            displayTracks(tracks, '<i class="fas fa-music"></i> Tracks');
            currentTracks = [...currentTracks, ...tracks];
        }
        
        if (artists.length > 0) {
            displayArtists(artists.slice(0, 6), '<i class="fas fa-user"></i> Artists');
        }
        
        if (albums.length > 0) {
            displayAlbums(albums.slice(0, 6), '<i class="fas fa-compact-disc"></i> Albums');
        }
    }
    
    // Handle track search
    function handleTrackSearch(data) {
        if (!data || !data.data || data.data.length === 0) {
            showError('No tracks found. Try a different search.');
            return;
        }
        
        resultsDiv.innerHTML = '';
        currentTracks = data.data;
        displayTracks(currentTracks, '<i class="fas fa-music"></i> Tracks');
    }
    
    // Handle artist search
    function handleArtistSearch(data) {
        if (!data || !data.data || data.data.length === 0) {
            showError('No artists found. Try a different search.');
            return;
        }
        
        resultsDiv.innerHTML = '';
        displayArtists(data.data.slice(0, 12), '<i class="fas fa-user"></i> Artists');
    }
    
    // Handle album search
    function handleAlbumSearch(data) {
        if (!data || !data.data || data.data.length === 0) {
            showError('No albums found. Try a different search.');
            return;
        }
        
        resultsDiv.innerHTML = '';
        displayAlbums(data.data.slice(0, 12), '<i class="fas fa-compact-disc"></i> Albums');
    }
    
    // Display tracks in the UI
    function displayTracks(tracks, sectionTitle, append = false) {
        if (!append) {
            resultsDiv.innerHTML = '';
            currentTracks = [];
        }
        
        if (tracks.length === 0) return;
        
        const section = document.createElement('div');
        section.innerHTML = `
            <div class="section-title">
                <span>${sectionTitle} (${tracks.length})</span>
                <div class="section-actions">
                    <button class="section-action" title="Play all" onclick="playAllTracks(${JSON.stringify(tracks).replace(/"/g, '&quot;')})">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            </div>
        `;
        resultsDiv.appendChild(section);
        
        tracks.forEach((track, index) => {
            const globalIndex = currentTracks.length;
            currentTracks.push(track);
            
            const isFavorite = favorites.some(fav => fav.id === track.id);
            
            const div = document.createElement("div");
            div.className = "track";
            div.innerHTML = `
                <img class="track-cover" src="${track.album.cover_medium}" alt="Album cover">
                <div class="track-info">
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist.name}</div>
                    <div class="track-album">${track.album.title}</div>
                    <div class="audio-container">
                        <audio id="audio-${globalIndex}" controls src="${track.preview}">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>
                <div class="track-actions">
                    <button class="track-action favorite ${isFavorite ? 'favorite' : ''}" onclick="toggleFavorite(${globalIndex}, this)">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button class="track-action" onclick="addToPlaylist(${globalIndex})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
            section.appendChild(div);
            
            // Set up audio element
            const audio = document.getElementById(`audio-${globalIndex}`);
            if (audio) {
                audio.addEventListener('play', function() {
                    updatePlayer(globalIndex);
                    setCurrentAudio(audio, globalIndex);
                });
                
                audio.addEventListener('timeupdate', function() {
                    if (this.currentTime >= 29 && !this.dataset.queuedNext) {
                        this.dataset.queuedNext = true;
                        playNextTrack();
                    }
                });
            }
        });
    }
    
    // Display artists in the UI
    function displayArtists(artists, sectionTitle) {
        const section = document.createElement('div');
        section.innerHTML = `
            <div class="section-title">
                <span>${sectionTitle} (${artists.length})</span>
            </div>
        `;
        resultsDiv.appendChild(section);
        
        artists.forEach(artist => {
            const div = document.createElement("div");
            div.className = "track";
            div.style.cursor = 'pointer';
            div.innerHTML = `
                <img class="track-cover" src="${artist.picture_medium}" alt="Artist picture">
                <div class="track-info">
                    <div class="track-title">${artist.name}</div>
                    <div class="track-artist">${artist.nb_fan.toLocaleString()} fans</div>
                    <div class="track-action" style="position: absolute; right: 15px; top: 15px;" onclick="fetchArtistTracks(${artist.id}, event)">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            `;
            div.addEventListener('click', function(e) {
                // Only navigate if the click wasn't on the arrow button
                if (!e.target.closest('.track-action')) {
                    fetchArtistTracks(artist.id);
                }
            });
            section.appendChild(div);
        });
    }
    
    // Display albums in the UI
    function displayAlbums(albums, sectionTitle) {
        const section = document.createElement('div');
        section.innerHTML = `
            <div class="section-title">
                <span>${sectionTitle} (${albums.length})</span>
            </div>
        `;
        resultsDiv.appendChild(section);
        
        albums.forEach(album => {
            const div = document.createElement("div");
            div.className = "track";
            div.style.cursor = 'pointer';
            div.innerHTML = `
                <img class="track-cover" src="${album.cover_medium}" alt="Album cover">
                <div class="track-info">
                    <div class="track-title">${album.title}</div>
                    <div class="track-artist">${album.artist.name}</div>
                    <div class="track-release">${new Date(album.release_date).getFullYear()} • ${album.nb_tracks} tracks</div>
                    <div class="track-action" style="position: absolute; right: 15px; top: 15px;" onclick="fetchAlbumTracks(${album.id}, event)">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            `;
            div.addEventListener('click', function(e) {
                // Only navigate if the click wasn't on the arrow button
                if (!e.target.closest('.track-action')) {
                    fetchAlbumTracks(album.id);
                }
            });
            section.appendChild(div);
        });
    }
    
    // Fetch tracks by artist
    function fetchArtistTracks(artistId, event = null) {
        if (event) event.stopPropagation();
        showLoading('Loading artist tracks...');
        
        const script = document.createElement('script');
        script.src = `https://api.deezer.com/artist/${artistId}/top?limit=50&output=jsonp&callback=handleArtistTracks`;
        document.body.appendChild(script);
    }
    
    // Handle artist tracks response
    function handleArtistTracks(data) {
        if (!data || !data.data || data.data.length === 0) {
            showError('No tracks found for this artist');
            return;
        }
        
        currentTracks = data.data;
        displayTracks(currentTracks, '<i class="fas fa-music"></i> Artist Tracks');
    }
    
    // Fetch tracks by album
    function fetchAlbumTracks(albumId, event = null) {
        if (event) event.stopPropagation();
        showLoading('Loading album tracks...');
        
        const script = document.createElement('script');
        script.src = `https://api.deezer.com/album/${albumId}/tracks?output=jsonp&callback=handleAlbumTracks`;
        document.body.appendChild(script);
    }
    
    // Handle album tracks response
    function handleAlbumTracks(data) {
        if (!data || !data.data || data.data.length === 0) {
            showError('No tracks found in this album');
            return;
        }
        
        currentTracks = data.data;
        displayTracks(currentTracks, '<i class="fas fa-music"></i> Album Tracks');
    }
    
    // Play all tracks
    function playAllTracks(tracks) {
        currentTracks = tracks;
        playTrack(0);
    }
    
    // Set current audio element and set up event listeners
    function setCurrentAudio(audio, index) {
        if (currentAudio) {
            currentAudio.removeEventListener('timeupdate', updateProgress);
            currentAudio.removeEventListener('ended', handleTrackEnd);
        }
        
        currentAudio = audio;
        currentTrackIndex = index;
        
        currentAudio.addEventListener('timeupdate', updateProgress);
        currentAudio.addEventListener('ended', handleTrackEnd);
        
        // Update play button state
        updatePlayButton();
    }
    
    // Update player UI with current track info
    function updatePlayer(index) {
        const track = currentTracks[index];
        if (!track) return;
        
        playerCover.src = track.album.cover_medium;
        playerTitle.textContent = track.title;
        playerArtist.textContent = track.artist.name;
        playerContainer.style.display = 'flex';
        
        // Update duration display
        durationEl.textContent = '0:30'; // Deezer previews are 30 seconds
    }
    
    // Update progress bar
    function updateProgress() {
        if (!currentAudio) return;
        
        const percent = (currentAudio.currentTime / currentAudio.duration) * 100;
        progressFill.style.width = `${percent}%`;
        
        // Update time display
        currentTimeEl.textContent = formatTime(currentAudio.currentTime);
    }
    
    // Format time (seconds to MM:SS)
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    
    // Handle track end
    function handleTrackEnd() {
        playNextTrack();
    }
    
    // Play a specific track
    function playTrack(index) {
        if (index < 0 || index >= currentTracks.length) return;
        
        // If we're already playing this track, just continue
        if (currentTrackIndex === index && isPlaying) return;
        
        // Stop current audio if playing
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        
        // Get the audio element
        const audioElement = document.getElementById(`audio-${index}`);
        if (!audioElement) return;
        
        // Play the audio
        audioElement.play()
            .then(() => {
                setCurrentAudio(audioElement, index);
                updatePlayer(index);
                isPlaying = true;
                updatePlayButton();
            })
            .catch(e => console.error('Playback failed:', e));
    }
    
    // Toggle play/pause
    function togglePlay() {
        if (!currentAudio) {
            if (currentTracks.length > 0) {
                playTrack(0);
            }
            return;
        }
        
        if (isPlaying) {
            currentAudio.pause();
        } else {
            currentAudio.play();
        }
        
        isPlaying = !isPlaying;
        updatePlayButton();
    }
    
    // Update play button state
    function updatePlayButton() {
        if (!currentAudio) return;
        
        const icon = playBtn.querySelector('i');
        if (isPlaying) {
            icon.classList.remove('fa-play');
            icon.classList.add('fa-pause');
        } else {
            icon.classList.remove('fa-pause');
            icon.classList.add('fa-play');
        }
    }
    
    // Play next track
    function playNextTrack() {
        const nextIndex = (currentTrackIndex + 1) % currentTracks.length;
        playTrack(nextIndex);
    }
    
    // Play previous track
    function playPreviousTrack() {
        let prevIndex = currentTrackIndex - 1;
        if (prevIndex < 0) prevIndex = currentTracks.length - 1;
        playTrack(prevIndex);
    }
    
    // Toggle favorite status
    function toggleFavorite(index, button) {
        const track = currentTracks[index];
        const favIndex = favorites.findIndex(fav => fav.id === track.id);
        
        if (favIndex >= 0) {
            // Remove from favorites
            favorites.splice(favIndex, 1);
            button.classList.remove('favorite');
        } else {
            // Add to favorites
            favorites.push(track);
            button.classList.add('favorite');
        }
        
        // Save to localStorage
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }
    
    // Show add to playlist modal
    function addToPlaylist(index) {
        const track = currentTracks[index];
        if (!track) return;
        
        // Store current track index for playlist addition
        playlistModal.dataset.trackIndex = index;
        
        // Populate playlists
        playlistModalBody.innerHTML = `
            <div class="new-playlist">
                <input type="text" id="newPlaylistName" placeholder="New playlist name">
                <button id="createPlaylistBtn">Create</button>
            </div>
            ${Object.keys(playlists).length > 0 ? '<h4>Your Playlists</h4>' : ''}
        `;
        
        // Add existing playlists
        Object.keys(playlists).forEach(name => {
            const playlistDiv = document.createElement('div');
            playlistDiv.className = 'playlist-item';
            playlistDiv.innerHTML = `
                ${name} (${playlists[name].length} tracks)
                <div class="playlist-actions">
                    <button class="playlist-action" onclick="addTrackToPlaylist('${name}', event)">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            `;
            playlistModalBody.appendChild(playlistDiv);
        });
        
        // Show modal
        playlistModal.style.display = 'flex';
    }
    
    // Close playlist modal
    function closePlaylistModal() {
        playlistModal.style.display = 'none';
    }
    
    // Create new playlist
    function createNewPlaylist() {
        const name = newPlaylistName.value.trim();
        if (!name) return;
        
        if (!playlists[name]) {
            playlists[name] = [];
        }
        
        // Add the current track
        const trackIndex = playlistModal.dataset.trackIndex;
        const track = currentTracks[trackIndex];
        
        if (!playlists[name].some(t => t.id === track.id)) {
            playlists[name].push(track);
            localStorage.setItem('playlists', JSON.stringify(playlists));
        }
        
        // Refresh the modal
        addToPlaylist(trackIndex);
        newPlaylistName.value = '';
    }
    
    // Add track to existing playlist
    function addTrackToPlaylist(name, event) {
        event.stopPropagation();
        
        const trackIndex = playlistModal.dataset.trackIndex;
        const track = currentTracks[trackIndex];
        
        if (!playlists[name].some(t => t.id === track.id)) {
            playlists[name].push(track);
            localStorage.setItem('playlists', JSON.stringify(playlists));
            
            // Visual feedback
            const button = event.target.closest('button');
            if (button) {
                button.innerHTML = '<i class="fas fa-check"></i> Added';
                button.style.color = '#2ecc71';
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-plus"></i> Add';
                    button.style.color = '';
                }, 2000);
            }
        }
    }
    
    // Load playlists from localStorage
    function loadPlaylists() {
        const savedPlaylists = localStorage.getItem('playlists');
        if (savedPlaylists) {
            playlists = JSON.parse(savedPlaylists);
        }
    }
    
    // Filter results based on current filter
    function filterResults() {
        // In a real app, you would re-fetch with the proper filter
        // For this demo, we'll just show a message
        searchMusic();
    }
    
    // Show loading state
    function showLoading(message) {
        resultsDiv.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>${message}</p>
            </div>
        `;
    }
    
    // Show error message
    function showError(message) {
        resultsDiv.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-circle"></i> ${message}
            </div>
        `;
    }
    
    // Initialize the app
    init();
</script>

</body>
</html>